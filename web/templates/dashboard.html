{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="/static/css/dashboard_v3.css?v=1.9"> <!-- Version bumped for cache-busting -->

<div class="dashboard-container">

    <!-- PHASE 4: Persistent Alarm Block -->
    <div class="grid-card alarm-card" id="run-alarm-block" style="display: none;">
        <div class="alarm-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
        <div class="alarm-content">
            <h4 class="alarm-title">OPERATOR ALERT</h4>
            <p class="alarm-message" id="run-alarm-message">Product size mismatch detected.</p>
        </div>
        <button class="btn btn-warning" id="acknowledge-alarm-btn">Acknowledge</button>
    </div>

    <!-- Live Process View Card with Animation -->
    <div class="grid-card animation-card">
        <h3 class="card-title"><i class="bi bi-truck-front"></i> Live Process View</h3>
        <div id="animation-zone" data-animation-time="{{ animation_time }}">
            <div id="conveyor-belt"></div>
            <div id="conveyor-overlay-info">
                <div class="info-box"><span class="info-label">ON BELT</span><span class="info-value" id="count-on-belt">0</span></div>
                <div class="info-box-main"><span class="info-label">PROCESSED</span><span class="info-value-main" id="count-exited">0</span></div>
                <div class="info-box"><span class="info-label">MODE</span><span class="info-value" id="conveyor-mode">STOPPED</span></div>
            </div>
        </div>
    </div>

    <!-- Run Status Section -->
    <div class="grid-card run-status-card">
        <h3 class="card-title" style="justify-content: center;"><i class="bi bi-stack"></i> Run Status</h3>
        <div class="progress-container">
            <svg class="progress-circle" viewBox="0 0 100 100">
                <circle class="progress-circle__trail" cx="50" cy="50" r="45"></circle>
                <circle class="progress-circle__path" id="progress-path" cx="50" cy="50" r="45"></circle>
            </svg>
            <div class="progress-text">
                <div id="progress-percentage">0%</div>
                <div id="progress-details">0 / ∞</div>
            </div>
        </div>
        <div class="status-line"><strong>Active Profile:</strong> <span class="badge" id="active-profile-display">None</span></div>
    </div>
    
    <!-- SIMPLIFIED Live Feeds Section -->
    <div class="grid-card feeds-card">
        <h3 class="card-title"><i class="bi bi-camera-video"></i> Live Camera Feed</h3>
        <div class="feeds-grid" style="grid-template-columns: 1fr;"><div class="camera-feed-container">
            <div class="camera-title-overlay" id="live-feed-title">CAMERA</div>
            <img id="live-camera-feed" src="/static/images/placeholder.jpg" alt="Live camera feed">
        </div></div>
    </div>

    <!-- Main Control Section -->
    <div class="grid-card control-card">
        <h3 class="card-title"><i class="bi bi-sliders"></i> Production Control</h3>
        <div class="control-grid-main">
            <div class="form-group">
                <label for="object-profile-select">1. Select Recipe</label>
                <select id="object-profile-select" class="form-select">
                    <option value="">-- Select a Profile --</option>
                    {% for p in object_profiles %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="target-count-input">2. Set Target Count (0 for ∞)</label>
                <input type="number" class="form-control" id="target-count-input" value="10" min="0">
            </div>
            <div class="control-buttons">
                <button class="btn-control btn-start" id="start-run-btn"><i class="bi bi-play-fill"></i> Load & Start Run</button>
                <button class="btn-control btn-stop" id="stop-run-btn"><i class="bi bi-stop-fill"></i> Stop Run</button>
                <button class="btn-control btn-reset" id="reset-all-btn"><i class="bi bi-arrow-counterclockwise"></i> Full Reset</button>
            </div>
        </div>
    </div>
</div>

<!-- PHASE 4: New Pre-Run Modal with multiple views -->
<div class="modal fade" id="pre-run-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pre-run-modal-title">Pre-Run Checklist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- View 1: Input Form -->
                <div id="pre-run-input-view">
                    <p class="text-muted">Please provide the following details before starting the run.</p>
                    <div class="mb-3">
                        <label for="operator-select" class="form-label">Operator*</label>
                        <select id="operator-select" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="batch-code-input" class="form-label">Batch Code*</label>
                        <input type="text" id="batch-code-input" class="form-control" required>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-primary" id="review-run-btn">Review Run</button>
                    </div>
                </div>
                <!-- View 2: Confirmation -->
                <div id="pre-run-confirm-view" style="display: none;">
                    <h6>Please confirm the following run details:</h6>
                    <ul class="list-group">
                        <li class="list-group-item"><strong>Operator:</strong> <span id="confirm-operator"></span></li>
                        <li class="list-group-item"><strong>Batch Code:</strong> <span id="confirm-batch-code"></span></li>
                        <li class="list-group-item"><strong>Recipe:</strong> <span id="confirm-recipe"></span></li>
                        <li class="list-group-item"><strong>Target:</strong> <span id="confirm-target"></span></li>
                    </ul>
                    <div class="alert alert-warning mt-3">This will start the conveyor belt and begin the production run.</div>
                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-secondary" id="go-back-btn">Go Back</button>
                        <button type="button" class="btn btn-success" id="start-final-run-btn">START FINAL RUN</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/dashboard_v3.js?v=1.9"></script>
{% endblock %}